---
layout: post
title: Compiling Ruby to Java Types
date: '2009-03-10T15:05:00.000-07:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:31.006-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-2288331201842816302
blogger_orig_url: http://blog.headius.com/2009/03/compiling-ruby-to-java-types.html
---

"Compiler #2" as it has been affectionately called is a compiler to turn normal Ruby classes into Java classes, so they can be constructed and called by normal Java code. When I asked for 1.3 priorities, this came out way at the top. Tom thought perhaps I asked for trouble putting it on the list, and he's probably right (like asking "prioritize these: sandwich, pencil, shiny gold ring with 5kt diamond, banana"), but I know this has been a pain point for people.<br /><br />I have just landed an early prototype of the compiler on trunk. I made a few decisions about it today:<br /><ul><li>It will use my bytecode DSL "<a href="http://kenai.com/projects/jvmscript">BiteScript</a>", just like <a href="http://kenai.com/projects/duby">Duby</a> does</li><li>It will use the *runtime* definition of a class to generate the Java version</li></ul>The second point is an important one. Instead of having an offline compiler that inspects a file and generates code from it, the compiler will actually used the runtime class to create a Java version. This means you'll be able to use all the usual metaprogramming facilities, and at whatever point the compiler picks up your class it will see all those methods.<br /><br />Here's an example:<div><br /><pre># myruby.rb<br />require 'rbconfig'<br /><br />class MyRubyClass<br />  def helloWorld<br />    puts "Hello from Ruby"<br />  end<br />  if Config::CONFIG['host_os'] =~ /mswin32/<br />    def goodbyeWorld(a)<br />      puts a<br />    end<br />  else<br />    def nevermore(*a)<br />      puts a<br />    end<br />  end<br />end</pre><br />Here we have a class that defines two methods. The first, always defined, is helloWorld. The second is conditionally either goodbyeWorld or nevermore, based on whether we're on Windows. Yes, it's a contrived example...bear with me.<br /><br />The compiler2 prototype can be invoked as follows (assuming bitescript is checked out into ../bitescript):<br /><br /><pre>jruby -I ../bitescript/lib/ tool/compiler2.rb MyObject MyRubyClass myruby</pre><br />A breakdown of these arguments is as follows:<br /><ul><li>-I ../bitescript/lib includes bitescript</li><li>tool/compiler2.rb is the compiler itself</li><li>MyObject is the name we'd like the Java class to have</li><li>MyRubyClass is the name of the Ruby class we want it to front</li><li>myruby is the library we want it to require to load that class</li></ul>Running this on OS X and dumping the resulting Java class gives us:<br /><br /><pre>Compiled from "MyObject.java.rb"<br />public class MyObject extends org.jruby.RubyObject{<br /> static {};<br /> public MyObject();<br /> public org.jruby.runtime.builtin.IRubyObject helloWorld();<br /> public org.jruby.runtime.builtin.IRubyObject nevermore(org.jruby.runtime.builtin.IRubyObject[]);<br />}</pre><br />The first thing to notice is that the compiler has generated a method for nevermore, since I'm not on Windows. I believe this will be unique among dynamic languages on the JVM: we will make the *runtime* set of methods available through the Java type, not just the static set present at compile time.<br /><br />Because there are no type signatures specified for MyRubyClass, all types have defaulted to IRubyObject. Type signature logic will come along shortly. And notice also this extends RubyObject; a limitation of the current setup is that you won't be able to use compiler2 to create subclasses. That will come later.<br /><br />Once you've run this, you've got a MyObject that can be instantiated and used directly. Behind the scenes, it uses a global JRuby instance, so JRuby's still there and you still need it in classpath, but you won't have to instantiate a runtime, pass it around, and so on. It should make integrating JRuby into Java frameworks that want a real class much easier.<br /><br />So, thoughts? Questions? Have a look at the code under <a href="http://svn.codehaus.org/jruby/trunk/jruby/tool/compiler2.rb">tool/compiler2.rb</a> in JRuby's repository. The entire compiler is so far only 78 lines of Ruby code.</div>