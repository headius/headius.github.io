---
layout: post
title: Zero to Production in 15 Minutes
date: '2008-08-24T10:30:00.000-07:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:31.371-08:00'
thumbnail: http://3.bp.blogspot.com/_HWobMsJuRHc/SLGjpKyrQ_I/AAAAAAAAABg/4w_99QGj1qs/s72-c/Picture+24.png
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-6783927713194777147
blogger_orig_url: http://blog.headius.com/2008/08/zero-to-production-in-15-minutes.html
---

There still seems to be confusion about the relative simplicity or difficulty of deploying a Rails app using JRuby. Many folks still look around for the old tools and the old ways (Mongrel, generally), assuming that "all that app server stuff" is too complicated. I figured I'd post a quick walkthrough to show how easy it actually is, along with links to everything to get you started.<br /><br />Here's the full session, in all its glory, for those who just want the commands:<br /><pre>~/work ➔ java -Xmx256M -jar ~/Downloads/glassfish-installer-v2ur2-b04-darwin.jar<br />~/work ➔ cd glassfish<br />~/work/glassfish ➔ chmod a+x lib/ant/bin/*<br />~/work/glassfish ➔ lib/ant/bin/ant -f setup.xml<br />~/work/glassfish ➔ bin/asadmin start-domain<br />~/work/glassfish ➔ cd ~/work/testapp<br />~/work/testapp ➔ jruby -S gem install warbler<br />~/work/testapp ➔ jruby -S gem install activerecord-jdbcmysql-adapter<br />~/work/testapp ➔ vi config/database.yml<br />~/work/testapp ➔ warble<br />~/work/testapp ➔ ../glassfish/bin/asadmin deploy --contextroot / testapp.war</pre>Now, on to the full walkthrough!<br /><br /><span style="font-weight: bold;">Prerequisites</span><br /><br /><span style="font-style: italic;">JRuby 1.1.3 or higher</span><br /><br />None of the steps in the main walkthrough require JRuby, since Warbler works fine under other Ruby implementations. But if you want to install and test against the JDBC ActiveRecord adapters, JRuby's the way. And in general, if you're deploying on JRuby, you should probably test and build on JRuby as well. Go to <a href="http://www.jruby.org/">www.jruby.org</a> under "<a href="http://dist.codehaus.org/jruby">Download!</a>" and grab the latest 1.1.x "bin" distribution. I link here <a href="http://dist.codehaus.org/jruby/jruby-src-1.1.3.tar.gz">JRuby 1.1.3 tarball</a> and <a href="http://dist.codehaus.org/jruby/jruby-src-1.1.3.zip">JRuby 1.1.3 zip</a> for your convenience. Download, unpack, put in PATH. That's all there is to it.<br /><br /><span style="font-style: italic;">Java 5 or higher</span><br /><br />Most systems already have a JVM installed. Here's some links to OpenJDK downloads for various platforms, in case you don't already have one.<br /><ul><li>Windows, Linux, Solaris: Download the JDK directly from Sun's <a href="http://java.sun.com/javase/downloads/index.jsp">Java SE Downloads</a> page. I typically download the JDK (Java Development Kit) because I find it convenient to have Java sources, compilers, and debugging tools available, but this walkthrough should work with the JRE (Java Runtime Environment) as well. Linux and Solaris users should also be able to use their packaging system of choice to install a JDK.<br /></li><li>OS X: The 32-bit Intel macs can't run the Apple Java 6, so you'll want to look at the <a href="http://landonf.bikemonkey.org/static/soylatte/">Soylatte Java 6</a> build for OS X to get the best performance. A small warning...it doesn't have Cocoa-based UI components, so it will use X11 if you start up a GUI app.</li><li>BSDs: FreeBSD users should check the <a href="http://www.freebsdfoundation.org/downloads/java.shtml">FreeBSD Java downloads</a> page. I believe there's a port for FreeBSD and package/port for OpenBSD but I couldn't dig up the details. We have had users on both platforms, though, so I know they work fine.</li><li>Others: There's basically a JDK for just about every platform, so if you're not on one of these just do a little digging. All you need to know is that it needs to be a full Java 5 or higher implementation.</li></ul><span style="font-style: italic;">Rails 2.0 or higher</span><br /><br />Hopefully by now most of you are on a 2.x version of Rails. This walkthrough will assume you've got Rails 2.0+ installed. If you're using JRuby, it's a simple "jruby -S gem install rails" or if you've got JRuby's bin in PATH, "gem install rails" should do the trick. Note that the Warbler (described later) should work in any Ruby implementation, since it's just a packager and it includes JRuby.<br /><br /><span style="font-weight: bold;">Step One: The App Server</span><br /><br />The words "Application Server" are terrifying to most Rubyists, to the point that they'll refuse to even try this deployment model. Of course, the ones that try it usually agree it's a much cleaner way to deploy apps, and generally they don't want to go back to any of the alternatives.<br /><br />Much of the teeth-gnashing seems to surround the perceived complexity of setting a server up. That was definitely the case 5 years ago, but today's servers have been vastly simplified. For this walkthrough, I'll use GlassFish, since it's FOSS, fast, and easy to install.<br /><br />I'm using GlassFish V2 UR2 (that's Version 2, Update Release 2) since it's very stable and by most accounts the best app server available, FOSS or otherwise. Not that I'm biased or anything. At any rate, it's hard to argue with the install process.<br /><br />1. Download from the <a href="https://glassfish.dev.java.net/downloads/v2ur2-b04.html">GlassFish V2 UR2 download page</a>. The download links start about halfway down the page and are range from 53MB (English localization) to 93MB (Multilanguage) in size.<br /><br />2. Run the GlassFish installer. The .jar file downloaded is an executable jar containing the installer for GlassFish as well as GlassFish itself. The -Xmx specified here increases the memory cap for the JVM from its default 64MB to 256MB, since the archive gets unpacked in memory.<br /><pre>~/work ➔ java -Xmx256M -jar ~/Downloads/glassfish-installer-v2ur2-b04-darwin.jar<br />glassfish<br />glassfish/docs<br />glassfish/docs/css<br />glassfish/docs/figures<br />...<br />glassfish/updatecenter/README<br />glassfish/updatecenter/registry/SYSTEM/local.xml<br />installation complete<br />~/work ➔ </pre>Before the unpack begins, the installer will pop up a GUI asking you to accept the GlassFish license.<br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://3.bp.blogspot.com/_HWobMsJuRHc/SLGjpKyrQ_I/AAAAAAAAABg/4w_99QGj1qs/s1600-h/Picture+24.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="http://3.bp.blogspot.com/_HWobMsJuRHc/SLGjpKyrQ_I/AAAAAAAAABg/4w_99QGj1qs/s320/Picture+24.png" alt="" id="BLOGGER_PHOTO_ID_5238147769275466738" border="0" /></a>Read the license or not...it's up to you. But to accept, you need to at least pretend you read it and scroll the license to the bottom.<br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://1.bp.blogspot.com/_HWobMsJuRHc/SLGj8kBf9kI/AAAAAAAAABo/JWQMo4KawD8/s1600-h/Picture+25.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="http://1.bp.blogspot.com/_HWobMsJuRHc/SLGj8kBf9kI/AAAAAAAAABo/JWQMo4KawD8/s320/Picture+25.png" alt="" id="BLOGGER_PHOTO_ID_5238148102466041410" border="0" /></a>The installer will proceed to unpack all the files for GlassFish into ./glassfish.<br /><br />3. Run the GlassFish setup script. In the unpacked glassfish directory, there are two .xml files: setup.xml and setup-cluster.xml. Most users will just want to use setup.xml here, but if you're interested in clustering several GlassFish instances across machine, you'll want to look into the clustered setup. I won't go into it here.<br /><br />The unpacked glassfish dir also contains Apache's Ant build tool, so you don't need to download it. If you already have it available, your copy should work fine, and the chmod command below--which sets the provided Ant's bin scripts executable--would be unnecessary. If you're on Windows, the bin scripts are bat files, so they'll work fine as-is.<br /><br />Two items to note: you should probably move the glassfish dir where you want it to live in production, and you should run the installer with the version of Java you'd like GlassFish to run under. Both can be changed later, but it's better to just get it right the first time.<br /><pre>~/work ➔ cd glassfish<br />~/work/glassfish ➔ chmod a+x lib/ant/bin/*<br />~/work/glassfish ➔ lib/ant/bin/ant -f setup.xml<br />Buildfile: setup.xml<br /><br />all:<br />[mkdir] Created dir: /Users/headius/work/glassfish/bin<br /><br />get.java.home:<br /><br />setup.init:<br />...<br />jar-unpack:<br />[unpack200] Unpacking with Unpack200<br />[unpack200] Source File :/Users/headius/work/glassfish/lib/appserv-cmp.jar.pack.gz<br />[unpack200] Dest.  File :/Users/headius/work/glassfish/lib/appserv-cmp.jar<br />[delete] Deleting: /Users/headius/work/glassfish/lib/appserv-cmp.jar.pack.gz<br />...<br />do.copy.unix:<br />[copy] Copying 1 file to /Users/headius/work/glassfish/config<br />[copy] Copying 1 file to /Users/headius/work/glassfish/bin<br />[copy] Copying 1 file to /Users/headius/work/glassfish/bin<br />...<br />create.domain:<br />[exec] Using port 4848 for Admin.<br />[exec] Using port 8080 for HTTP Instance.<br />[exec] Using port 7676 for JMS.<br />...<br />BUILD SUCCESSFUL<br />Total time: 29 seconds<br />~/work/glassfish ➔ </pre>4. Start up your GlassFish server. It's as simple as one command now.<br /><pre>~/work/glassfish ➔ bin/asadmin start-domain<br />Starting Domain domain1, please wait.<br />Log redirected to /Users/headius/work/glassfish/domains/domain1/logs/server.log.<br />Redirecting output to /Users/headius/work/glassfish/domains/domain1/logs/server.log<br />Domain domain1 is ready to receive client requests. Additional services are being started in background.<br />Domain [domain1] is running [Sun Java System Application Server 9.1_02 (build b04-fcs)] with its configuration and logs at: [/Users/headius/work/glassfish/domains].<br />Admin Console is available at [http://localhost:4848].<br />Use the same port [4848] for "asadmin" commands.<br />User web applications are available at these URLs:<br />[http://localhost:8080 https://localhost:8181 ].<br />Following web-contexts are available:<br />[/web1  /__wstx-services ].<br />Standard JMX Clients (like JConsole) can connect to JMXServiceURL:<br />[service:jmx:rmi:///jndi/rmi://charles-nutters-computer.local:8686/jmxrmi] for domain management purposes.<br />Domain listens on at least following ports for connections:<br />[8080 8181 4848 3700 3820 3920 8686 ].<br />Domain does not support application server clusters and other standalone instances.<br /><br />~/work/glassfish ➔ </pre>Congratulations! You have installed GlassFish. Simple, eh?<br /><br />A few tips for using your new server:<br /><ul><li>There's a web-based admin page at http://localhost:4848 where the admin login is <span style="font-weight: bold;">admin/adminadmin</span> by default. <span style="font-weight: bold; font-style: italic;">You'll want to change that password.</span> Select "Application Server" on the left and then "Administrator Password" along the top.<a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://2.bp.blogspot.com/_HWobMsJuRHc/SLGpDjWQB-I/AAAAAAAAABw/uXlorZdreRc/s1600-h/Picture+26.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="http://2.bp.blogspot.com/_HWobMsJuRHc/SLGpDjWQB-I/AAAAAAAAABw/uXlorZdreRc/s320/Picture+26.png" alt="" id="BLOGGER_PHOTO_ID_5238153720101865442" border="0" /></a><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://1.bp.blogspot.com/_HWobMsJuRHc/SLGuUfgY4DI/AAAAAAAAAB4/7UksDlDkxnI/s1600-h/Picture+28.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="http://1.bp.blogspot.com/_HWobMsJuRHc/SLGuUfgY4DI/AAAAAAAAAB4/7UksDlDkxnI/s320/Picture+28.png" alt="" id="BLOGGER_PHOTO_ID_5238159508686561330" border="0" /></a></li><li>Poke around the admin console to get a feel for the services provided. You won't need any of them for the rest of this walkthrough, but you might want to dabble some day. And if you want to set up a connection pool later on (which ActiveRecord-JDBC supports) this is where you'll do it.</li><li>Most folks will probably want to set up init scripts to ensure GlassFish is launched at server startup. That's outside the scope of this walkthrough, but it's pretty simple. I'll update this page (and it's equivalent on the <a href="http://wiki.jruby.org/">JRuby Wiki</a>) once I know more.</li><li>GlassFish works just fine as a standalone server, but many users will want to proxy it through Apache or another web server. Again, this is outside the scope of this walkthrough, but it should be as simple as configuring a virtual host or a set of matching URLs to hit the GlassFish server at port 8080 (which is the default port for web applications). For apps I'm running, however, I just use GlassFish.<br /></li></ul><span style="font-weight: bold;">Step 2: Package your App<br /></span><br />This step is made super-trivial by Nick Sieger's <a href="http://wiki.jruby.org/wiki/Warbler">Warbler</a>. It includes JRuby itself and provides a simple set of commands to package up your app, add a packaging config file, and more. In this case, I'll just be packaging up a simple Rails app.<br /><br />Note that Warbler works just fine under non-JRuby Ruby implementations, since it's all Ruby code. But again, if you're deploying with JRuby, it's probably a good idea to test and build with JRuby as well.<br /><pre>~/work ➔ jruby -S gem install warbler<br />Successfully installed warbler-0.9.10<br />1 gem installed<br />Installing ri documentation for warbler-0.9.10...<br />Installing RDoc documentation for warbler-0.9.10...<br />~/work ➔ cd testapp<br />~/work/testapp ➔ ls .<br />README   Rakefile app      config   db       doc      lib      log      public   script   test     tmp      vendor<br />~/work/testapp ➔ warble<br />jar cf testapp.war -C tmp/war .<br />~/work/testapp ➔ </pre>And that's essentially all there is to it. You will get a .war file containing your app, JRuby, Rails, and the Ruby standard library. This one file is now a deployable Rails applications, suitable for any app server, any OS, and any platform without a recompile. The target server doesn't even have to have JRuby or Rails installed.<br /><br /><span style="font-weight: bold;">Step 3: Deploy your Application</span><br /><br />There's two ways you can deploy. You can either go to the Admin Console web page, select "Web Applications" from the "Applications" category on the left, and deploy the file there, or you can just use GlassFish's command-line interface. I will demonstrate the latter, and I'm providing the optional contextroot flag to deploy my app at the root context.<br /><pre>~/work/testapp ➔ ../glassfish/bin/asadmin deploy --contextroot / testapp.war<br />Command deploy executed successfully.<br />~/work/testapp ➔ </pre>That's it? Yep, that's it! If we now hit the server at port 8080, we can see the app is deployed.<br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://3.bp.blogspot.com/_HWobMsJuRHc/SLGxVpZJ7RI/AAAAAAAAACA/IaW8wQgpXzo/s1600-h/Picture+29.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="http://3.bp.blogspot.com/_HWobMsJuRHc/SLGxVpZJ7RI/AAAAAAAAACA/IaW8wQgpXzo/s400/Picture+29.png" alt="" id="BLOGGER_PHOTO_ID_5238162827055328530" border="0" /></a><span style="font-weight: bold;">Step 4: Tweaking</span><br /><br />There's a few things you can do to tweak your deployment a bit. The first would be to generate a warble.rb config file and adjust settings to suit your application.<br /><pre>~/work/testapp ➔ warble config<br />~/work/testapp ➔ head config/warble.rb<br /># Warbler web application assembly configuration file<br />Warbler::Config.new do |config|<br /># Temporary directory where the application is staged<br /># config.staging_dir = "tmp/war"<br /><br /># Application directories to be included in the webapp.<br />config.dirs = %w(app config lib log vendor tmp)<br />...</pre>In this file you can set the min/max number of Rails instances you need, additional files and directories to include, additional gems and libraries to include, and so on. The file is heavily commented, so you should have no trouble figuring it out, but otherwise the Warbler page on the JRuby Wiki is probably your best source of information. And since a lot of people ask how many instances they should use, I'll provide a definitive answer: it depends. Try the defaults, and scale up or down as appropriate. Hopefully with Rails 2.2 this will no longer be needed, as is the case for Merb and friends.<br /><br />The other tweak you'll probably want to look into is using the JDBC-based ActiveRecord adapters instead of the pure Ruby versions (or the C-based versions, if you're migrating from the C-based Ruby impls). This is generally pretty simple too. Install the JDBC adapter for your database, and tweak your database.yml. Here's the commands on my system:<br /><pre>~/work/testapp ➔ jruby -S gem install activerecord-jdbcmysql-adapter<br />Successfully installed jdbc-mysql-5.0.4<br />Successfully installed activerecord-jdbcmysql-adapter-0.8.2<br />2 gems installed<br />Installing ri documentation for jdbc-mysql-5.0.4...<br />Installing ri documentation for activerecord-jdbcmysql-adapter-0.8.2...<br />Installing RDoc documentation for jdbc-mysql-5.0.4...<br />Installing RDoc documentation for activerecord-jdbcmysql-adapter-0.8.2...<br />~/work/testapp ➔ vi config/database.yml<br />~/work/testapp ➔ </pre>And the modified database.yml file:<br /><pre>...<br /># This was changed from "adapter: mysql"<br />production:<br />adapter: jdbcmysql<br />encoding: utf8<br />...</pre>Now repackage ("warble" command again), redeploy, and you're done!<br /><br /><span style="font-weight: bold;">Conclusion</span><br /><br />Hopefully this walkthrough clears up some confusion around JRuby on Rails deployment to an app server. It's really a simple process, despite the not-so-simple history surrounding Enterprise Application Servers, and GlassFish almost makes it fun :)