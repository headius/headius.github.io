---
layout: post
title: Flat and Graph Profiles for JRuby 1.6
date: '2011-01-04T03:31:00.000-08:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:30.216-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-2769363753545887472
blogger_orig_url: http://blog.headius.com/2011/01/flat-and-graph-profiles-for-jruby-16.html
---

<div>Sometimes it's the little things that make all the difference in the world.</div><br /><div>For a long time, we've extolled the virtues of the amazing JVM tool ecosystem. There's literally dozens of profiling, debugging, and monitoring tools, making JRuby perhaps the best Ruby tool ecosystem you can get. But there's a surprising lack of tools for command-line use, and that's an area many Rubyists take for granted.</div><br /><div>To help improve the situation, we recently got the ruby-debug maintainers to ship our JRuby version, so<a href="http://blog.headius.com/2010/12/jruby-finally-installs-ruby-debug-gem.html"> JRuby has easy-to-use command-line Ruby debugging support</a>. You can simply "gem install ruby-debug" now, so we'll stop shipping it in JRuby 1.6.</div><br /><div>We also shipped a basic "flat" instrumented profiler for JRuby 1.5.6. It's almost shocking how few command-line profiling tools there are available for JVM users; most require you to boot up a GUI and click a bunch of buttons to get any information at all. Even when there are tools for profiling, they're often bad at reporting results for non-Java languages like JRuby. So we decided to whip out a --profile flag that gives you a basic, flat, instrumented profile of your code.</div><br /><div>To continue this trend, we enlisted the help of <a href="http://danlucraft.com/">Dan Lucraft</a> of the <a href="http://redcareditor.com/">RedCar</a> project to expand our profiler to include "graph" profiling results. Dan previously implemented JRuby support for the "ruby-prof" project, a native extension to C Ruby, in the form of "<a href="https://github.com/danlucraft/jruby-prof">jruby-prof</a>" (which you can install and use today on any recent JRuby release). He was a natural to work on the built-in profiling support.</div><br /><div>For the uninitiated, "flat" profiles just show how much time each method body takes, possibly with downstream aggregate times and total aggregate times. This is what you usually get from built-in command-line profilers like the "hprof" profiler that ships with Hotspot/OpenJDK. Here's a "flat" profile for a simple piece of code.</div><br /><div><pre>~/projects/jruby ➔ jruby --profile.flat -e "def foo; 100000.times { (2 ** 200).to_s }; end; foo"<br />Total time: 0.99<br /><br />    total        self    children       calls  method<br />----------------------------------------------------------------<br />     0.99        0.00        0.99           1  Object#foo<br />     0.99        0.08        0.90           1  Fixnum#times<br />     0.70        0.70        0.00      100000  Bignum#to_s<br />     0.21        0.21        0.00      100000  Fixnum#**<br />     0.00        0.00        0.00         145  Class#inherited<br />     0.00        0.00        0.00           1  Module#method_added</pre></div><br /><div>A "graph" profile shows the top N call stacks from your application's run, breaking them down by how much time is spent in each method. It gives you a more complete picture of where time is being spent while running your application. Here's a "graph" profile (abbreviated) for the same code.</div><br /><div><pre>~/projects/jruby ➔ jruby --profile.graph -e "def foo; 100000.times { (2 ** 200).to_s }; end; foo"<br />%total   %self    total        self    children                 calls  name<br />---------------------------------------------------------------------------------------------------------<br />100%     0%        1.00        0.00        1.00                     0  (top)<br />                   1.00        0.00        1.00                   1/1  Object#foo<br />                   0.00        0.00        0.00               145/145  Class#inherited<br />                   0.00        0.00        0.00                   1/1  Module#method_added<br />---------------------------------------------------------------------------------------------------------<br />                   1.00        0.00        1.00                   1/1  (top)<br /> 99%     0%        1.00        0.00        1.00                     1  Object#foo<br />                   1.00        0.09        0.91                   1/1  Fixnum#times<br />---------------------------------------------------------------------------------------------------------<br />                   1.00        0.09        0.91                   1/1  Object#foo<br /> 99%     8%        1.00        0.09        0.91                     1  Fixnum#times<br />                   0.70        0.70        0.00         100000/100000  Bignum#to_s<br />                   0.21        0.21        0.00         100000/100000  Fixnum#**<br />---------------------------------------------------------------------------------------------------------<br />                   0.70        0.70        0.00         100000/100000  Fixnum#times<br /> 69%    69%        0.70        0.70        0.00                100000  Bignum#to_s<br />---------------------------------------------------------------------------------------------------------<br />                   0.21        0.21        0.00         100000/100000  Fixnum#times<br /> 21%    21%        0.21        0.21        0.00                100000  Fixnum#**<br />---------------------------------------------------------------------------------------------------------<br />                   0.00        0.00        0.00               145/145  (top)<br />  0%     0%        0.00        0.00        0.00                   145  Class#inherited<br />---------------------------------------------------------------------------------------------------------<br />                   0.00        0.00        0.00                   1/1  (top)<br />  0%     0%        0.00        0.00        0.00                     1  Module#method_added</pre></div><br /><div>As you can see, you get a much better picture of why certain methods are taking up time and what component calls are contributing most to that time.</div><br /><div>We haven't settled on the final command-line flags, but look for the new graph profiling (and the cleaned-up flat profile) to ship with JRuby 1.6 (real soon now!)</div>