---
layout: post
title: Advanced Rails Deployment with JRuby
date: '2006-11-17T09:43:00.000-08:00'
author: headius
tags:
- rails
- ruby
- glassfish
- mongrel
- jruby
- java
modified_time: '2011-01-25T21:44:33.558-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-5627273246444779297
blogger_orig_url: http://blog.headius.com/2006/11/advanced-rails-deployment-with-jruby.html
---

There's a lot of work going on right now focusing on various mechanisms for deploying JRuby-based apps. This article will summarize some of the work happening and why it's really, really important for the Ruby world.<br /><br /><span style="font-weight: bold;">Ruby-in-a-JAR</span><br /><br />First, a little sideline into general Ruby embeddability work.<br /><br />Over the past few days I've made modifications to enable running a Ruby app completely out of a single JRuby JAR file (Java ARchive). The major changes required were:<br /><ol><li>Add <a href="http://tonicsystems.com/products/jarjar/">jarjar</a> to the project to combine all dependency jars into a single archive, including jline (readline support), asm (compiler, other stuff in the future), bsf (scripting API), jvyaml and plaincharset (Ola's JvYAML library and supporting charset lib).</li><li>Add an Ant task to build the "complete" jar and include all Ruby standard libraries in the same archive.</li><li>Somewhat unrelated, a small patch for irb/init.rb to allow it to fail gracefully if it can't load locale-specific files from the filesystem.</li></ol>So by running "ant jar-complete" you get out a single JAR file that contains a complete, working Ruby interpreter plus stdlib. For example:<br /><pre>~ $ java -jar jruby-complete.jar -e "puts 'Hello, Ruby-in-a-JAR!'"<br />Hello, Ruby-in-a-JAR!<br />~ $ java -jar jruby-complete.jar -rirb -e "IRB.start"<br />irb(main):001:0&gt;</pre>Of course, you don't have to take my word for it. I've uploaded a copy of this jar for you to try yourself. The full archive is about 2900kb. That's suitable for embedding in just about any application, and in fact I used a stripped-down 1600kb version for the <a href="http://headius.blogspot.com/2006/11/ruby-for-web-check.html">JRuby Applet</a>. Note: this is JRuby trunk code and mostly experimental...but that's what makes it so fun :)<br /><br /><a href="http://www.headius.com/~headius/jruby-complete.jar">Ruby-in-a-JAR</a> - The ultimate in Ruby interpreter portability<br /><br /><span style="font-weight: bold;">A Better Deployment for Rails</span><br /><br />Now the main course: several folks have been working on several exciting deployment scenarios for JRuby on Rails apps.<br /><br />The current "best option" for deploying Rails apps into production generally involves the HTTP front-end Mongrel. Although Mongrel is largely written in Ruby, it is very fast, largely because of its native C component for HTTP request parsing. It's also considerably more secure than CGI-based options, largely because of creator Zed Shaw's attention to detail. The typical Rails app will be deployed as a "pack of Mongrels", where the number of desired concurrent requests is multiplied by the number of independent Rails apps to determine a total number of processes. These processes must be managed, monitored, and respawned as appropriate, but the result is a fairly stable and scalable deployment model.<br /><br />However with JRuby, there will soon be a better option. I previously reported about TAKAI Naoto's efforts to deploy <a href="http://rails-asyncweb.sourceforge.net/">Rails behind an AsyncWeb front-end</a>, showing tremendous performance improvements over a WEBrick-based deployment. Naoto-san has now taken things to the next level: <a href="http://recompile.net/2006/11/how_to_deploy_jruby_on_rails_a.html">Rails deployment under GlassFish</a>.<br /><br />The potential here should be obvious. GlassFish, like other Java EE application servers, is extremely good at scaling up many concurrent requests across many independent applications; so good that many organizations deploy only a single appserver-per-machine and stuff it full of applications to serve. That means a single server, a single process to manage. GlassFish also supports clustering, which means you'll be able to hit the deploy button once and have your n-server cluster instantly start serving up Rails. But there's one last area that trumps all the rest:<br /><br />That single app server can handle as many concurrent requests across as many independent Rails apps as you desire, scaling them across all the CPU cores you can throw at it.<br /><br />That's right...no more N * M process management, no more zombie processes, no more immature tooling to manage all those servers and all those deployments. One tool, one server process, no headaches.<br /><br />That's an extremely bright future, and we're almost there.<br /><br /><span style="font-weight: bold;">What Next?</span><br /><br />Naoto-san is not the only one working on JRuby on Rails deployment options. There are a number of folks in the JRuby community approaching the same goal from different directions, using innovative techniques like servlets implemented in Ruby and Spring-based service wiring. The JRuby community sees the potential here and things are moving very quickly.<br /><br />My work on Ruby-in-a-JAR will also play directly into this. Currently most deployment scenarios require Rails app files to remain "loose" on the filesystem, as with the current standard deployment model. However it won't be long before you can zip up your Rails app into a WAR file (Web ARchive) and deploy it lock, stock, and barrel to as many servers as you want.<br /><br />These efforts combined will create, in my opinion, the most manageable, scalable, powerful Rails deployment model yet available...and it's just around the corner.<br /><br />We've also launched into Rails compatibility work in earnest. I've created a wiki page on <a href="http://www.headius.com/jrubywiki/index.php/Rails_Support">JRuby support for Rails</a> that details the results of running Rails' own test cases. Long story short: we're looking pretty damn good.<br /><br />JRuby on Rails is in the home stretch. And we're covering ground very quickly.