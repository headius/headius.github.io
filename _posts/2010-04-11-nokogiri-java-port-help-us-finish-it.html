---
layout: post
title: 'Nokogiri Java Port: Help Us Finish It!'
date: '2010-04-11T10:27:00.000-07:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:30.533-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-6964077812056409444
blogger_orig_url: http://blog.headius.com/2010/04/nokogiri-java-port-help-us-finish-it.html
---

One of the most commonly used native extensions for Ruby is the <a href="http://github.com/tenderlove/nokogiri">Nokogiri</a> XML API. Nokogiri wraps libxml and has a fair amount of C code that links directly against the Ruby C extension API...an API we don't support in JRuby (and won't, without a lot of community help).<br /><br />A bit over a year ago, the Nokogiri folks did us a big favor by creating an <a href="http://github.com/tenderlove/nokogiri/tree/master/lib/nokogiri/ffi/">FFI version of Nokogiri</a> that works surprisingly well; it's probably the most widely-used FFI-based Ruby library around. But the endgame for Nokogiri on JRuby has always been to get a <a href="http://github.com/tenderlove/nokogiri/tree/java">pure-Java version</a>. Not everyone is allowed to link native libraries on their Java platform of choice, and those that are often have trouble getting the right libxml versions installed. The Java version needs to happen.<br /><br />That day is very close.<br /><br />I spent a bit of time this weekend getting the Nokogiri "java" port running on my system, and the folks working on it have brought it almost to 100% passing. It's time to push it over the edge.<br /><br /><span style="font-weight: bold;">Building and Testing</span><br /><br />Here's my process for getting it building. Let me know if this needs to be edited.<br /><br /><span style="font-weight:bold;"><span style="font-style:italic;">Update:</span></span> Added rake-compiler and hoe to gems you need to install and modified the git command-line for versions that don't automatically create a local tracking branch.<br /><br />1. Clone the Nokogiri repository and switch to the "java" branch<br /><pre>~/projects ➔ git clone git://github.com/tenderlove/nokogiri.git<br />Initialized empty Git repository in /Users/headius/projects/nokogiri/.git/<br />remote: Counting objects: 14767, done.<br />remote: Compressing objects: 100% (3882/3882), done.<br />remote: Total 14767 (delta 10482), reused 13969 (delta 9945)<br />Receiving objects: 100% (14767/14767), 3.73 MiB | 742 KiB/s, done.<br />Resolving deltas: 100% (10482/10482), done.<br /><br />~/projects ➔ cd nokogiri/<br /><br />~/projects/nokogiri ➔ git checkout -b java origin/java<br />Branch java set up to track remote branch java from origin.<br />Switched to a new branch 'java'</pre><br />2. Install racc, rexical, rake-compiler, and hoe into Ruby (C Ruby, that is, since they also have extensions)<br /><pre>~/projects/nokogiri ➔ sudo gem install racc rexical rake-compiler hoe<br />Building native extensions.  This could take a while...<br />Successfully installed racc-1.4.6<br />Successfully installed rexical-1.0.4<br />Successfully installed rake-compiler-0.7.0<br />Successfully installed hoe-2.6.0<br />4 gems installed</pre><br />3. Build the lexer and parser using C Ruby<br /><pre>~/projects/nokogiri ➔ rake gem:dev:spec<br />(in /Users/headius/projects/nokogiri)<br />warning: couldn't activate the debugging plugin, skipping<br />rake-compiler must be configured first to enable cross-compilation<br />/usr/bin/racc -l -o lib/nokogiri/css/generated_parser.rb lib/nokogiri/css/parser.y<br />rex --independent -o lib/nokogiri/css/generated_tokenizer.rb lib/nokogiri/css/tokenizer.rex</pre><br />4. Build the Java bits (using rake in JRuby)<br /><pre>~/projects/nokogiri ➔ jruby -S rake java:build<br />(in /Users/headius/projects/nokogiri)<br />warning: couldn't activate the debugging plugin, skipping<br />javac -g -cp /Users/headius/projects/jruby/lib/jruby.jar:../../lib/nekohtml.jar:../../lib/nekodtd.jar:../../lib/xercesImpl.jar:../../lib/isorelax.jar:../../lib/jing.jar nokogiri/*.java nokogiri/internals/*.java<br />jar cf ../../lib/nokogiri/nokogiri.jar nokogiri/*.class nokogiri/internals/*.class</pre><br />5. Run the tests (again with rake on JRuby)<br /><pre>~/projects/nokogiri ➔ jruby -S rake test<br />(in /Users/headius/projects/nokogiri)<br />...<a href="http://gist.github.com/362908">full output</a>...</pre><br />On my system, I get about 8 failures and 19 errors, out of 785 tests and 1657 assertions. We're very close!<br /><br />A few other useful tasks:<br /><ul><li>jruby -S rake java:clean_all wipes out the build Java stuff</li><li>jruby -S rake java:gem builds the Java gem, if you want to try installing it</li></ul><span style="font-weight: bold;"><span style="font-style: italic;">Helping Out</span></span><br /><br />If you'd like to help fix these bugs, there's a few ways to approach it.<br /><ul><li>Join the <a href="http://groups.google.com/group/nokogiri-talk?pli=1">nokogiri-talk Google Group</a> so you can communicate with others working on the port. The key folks right now are <a href="http://yokolet.blogspot.com/">Yoko Harada</a> and <a href="http://www.serabe.com/">Sergio Arbeo</a> (who did the original bulk of the work for GSoC 2009). I'm also poking at it a bit in my spare time.</li><li>Post to the group to let folks know you want to help. This will help avoid duplicated effort.</li><li>Pick tests that appear to be missing or incorrect Ruby logic, like "not implemented", nil results ("method blah not found for nil") or arity errors ("3 arguments for 2" kinds of things). These are often the simplest ones to fix.</li><li>Don't give up! We're almost there!</li></ul>It would be great if we could have a 100% working Nokogiri Java port for JRuby 1.5 final this month. I hope to see you on the nokogiri-talk list! Feel free to comment here if you have questions about getting bootstrapped.