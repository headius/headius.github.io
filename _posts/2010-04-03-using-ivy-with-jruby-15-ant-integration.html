---
layout: post
title: Using Ivy with JRuby 1.5's Ant Integration
date: '2010-04-03T15:18:00.000-07:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:30.566-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-6244628372142249938
blogger_orig_url: http://blog.headius.com/2010/04/using-ivy-with-jruby-15-ant-integration.html
---

JRuby 1.5 will be released soon, and one of the coolest new features is the integration of Ant support into Rake, the Ruby build tool. Tom Enebo wrote an article on the <a href="http://www.engineyard.com/blog/2010/rake-and-ant-together-a-pick-it-n-stick-it-approach/">Rake/Ant integration</a> for the Engine Yard blog, which has lots of examples of how to start migrating to Rake without leaving Ant behind. I'm not going to cover all that here.<br /><br />I've been using the Rake/Ant stuff for a few weeks now, first for my <a href="http://github.com/headius/weakling">"weakling" RubyGem</a> which adds a queue-supporting WeakRef to JRuby, and now for cleaning up <a href="http://github.com/headius/duby">Duby</a>'s build process. Along the way, I've realized I really never want to write Ant scripts again; they're so much nicer in Rake, and I have all of Ruby and Ant available to me.<br /><br />One thing Ant still needs help with is dependency resolution. Many people make the leap to <a href="http://maven.apache.org/">Maven</a>, and let it handle all the nuts and bolts. But that only works if you really buy into the Maven way of life...a problem if you're like me and you live in a lot of hybrid worlds where the Maven way doesn't necessarily fit. So many folks are turning to <a href="http://ant.apache.org/ivy/">Apache Ivy</a> to get dependency management in their builds without using Maven.<br /><br />Today I thought I'd translate the simple <a href="http://ant.apache.org/ivy/history/latest-milestone/samples/build.xml">"no-install" Ivy example build</a> (warning, XML) to Rake, to see how easy it would be. The results are pretty slick.<br /><br />First we need to construct the equivalent to the "download-ivy" and "install-ivy" ant tasks. I chose to put that in a Rake namespace, like this:<br /><pre>namespace :ivy do<br />  ivy_install_version = '2.0.0-beta1'<br />  ivy_jar_dir = './ivy'<br />  ivy_jar_file = "#{ivy_jar_dir}/ivy.jar"<br /><br />  task :download do<br />    mkdir_p ivy_jar_dir<br />    ant.get :src =&gt; "http://repo1.maven.org/maven2/org/apache/ivy/ivy/#{ivy_install_version}/ivy-#{ivy_install_version}.jar",<br />      :dest =&gt; ivy_jar_file,<br />      :usetimestamp =&gt; true<br />  end<br /><br />  task :install =&gt; :download do<br />    ant.path :id =&gt; 'ivy.lib.path' do<br />      fileset :dir =&gt; ivy_jar_dir, :includes =&gt; '*.jar'<br />    end<br /><br />    ant.taskdef :resource =&gt; "org/apache/ivy/ant/antlib.xml",<br />      #:uri =&gt; "antlib:org.apache.ivy.ant",<br />      :classpathref =&gt; "ivy.lib.path"<br />  end<br />end</pre><br />Notice that instead of using Ant properties, I've just used Ruby variables for the Ivy install version, dir, and file. I've also removed the "uri" element to ant.taskdef because I'm not sure if we have an equivalent for that in Rake yet (note to self: figure out if we have an equivalent for that).<br /><br />With these two tasks, we can now fetch ivy and install it for the remainder of the build. Here's running the download task from the command line:<br /><pre>~/projects/duby ➔ rake ivy:download<br />(in /Users/headius/projects/duby)<br />mkdir -p ./ivy<br />Getting: http://repo1.maven.org/maven2/org/apache/ivy/ivy/2.0.0-beta1/ivy-2.0.0-beta1.jar<br />To: /Users/headius/projects/duby/ivy/ivy.jar</pre><br />Now we want a simple task that uses ivy:install to fetch resources and make them available for the build. Here's the example from Apache, using the cachepath task, written in Rake:<br /><pre>task :go =&gt; "ivy:install" do<br />  ant.cachepath :organisation =&gt; "commons-lang",<br />    :module =&gt; "commons-lang",<br />    :revision =&gt; "2.1",<br />    :pathid =&gt; "lib.path.id",<br />    :inline =&gt; "true"<br />end</pre><br />Pretty clean and simple, and it fits nicely into the flow of the Rakefile. I can also switch this to using the "retrieve" task, which just pulls the jars down and puts them where I want them:<br /><pre>task :go =&gt; "ivy:install" do<br />  ant.retrieve :organisation =&gt; 'commons-lang',<br />    :module =&gt; 'commons-lang',<br />    :revision =&gt; '2.1',<br />    :pattern =&gt; 'javalib/[conf]/[artifact].[ext]',<br />    :inline =&gt; true<br />end</pre><br />This fetches the Apache Commons Lang package along with all dependencies into javalib, separated by what build configuration they are associated with (runtime, test, etc). Here it is in action:<br /><pre>~/projects/duby ➔ rake go<br />(in /Users/headius/projects/duby)<br />mkdir -p ./ivy<br />Getting: http://repo1.maven.org/maven2/org/apache/ivy/ivy/2.0.0-beta1/ivy-2.0.0-beta1.jar<br />To: /Users/headius/projects/duby/ivy/ivy.jar<br />Not modified - so not downloaded<br />Trying to override old definition of task buildnumber<br />:: Ivy 2.1.0 - 20090925235825 :: http://ant.apache.org/ivy/ ::<br />:: loading settings :: url = jar:file:/Users/headius/.ant/lib/ivy.jar!/org/apache/ivy/core/settings/ivysettings.xml<br />:: resolving dependencies :: commons-lang#commons-lang-caller;working<br /> confs: [default, master, compile, provided, runtime, system, sources, javadoc, optional]<br /> found commons-lang#commons-lang;2.1 in public<br />:: resolution report :: resolve 64ms :: artifacts dl 3ms<br /> ---------------------------------------------------------------------<br /> |                  |            modules            ||   artifacts   |<br /> |       conf       | number| search|dwnlded|evicted|| number|dwnlded|<br /> ---------------------------------------------------------------------<br /> |      default     |   1   |   0   |   0   |   0   ||   1   |   0   |<br /> |      master      |   1   |   0   |   0   |   0   ||   1   |   0   |<br /> |      compile     |   1   |   0   |   0   |   0   ||   0   |   0   |<br /> |     provided     |   1   |   0   |   0   |   0   ||   0   |   0   |<br /> |      runtime     |   1   |   0   |   0   |   0   ||   0   |   0   |<br /> |      system      |   1   |   0   |   0   |   0   ||   0   |   0   |<br /> |      sources     |   1   |   0   |   0   |   0   ||   1   |   0   |<br /> |      javadoc     |   1   |   0   |   0   |   0   ||   1   |   0   |<br /> |     optional     |   1   |   0   |   0   |   0   ||   0   |   0   |<br /> ---------------------------------------------------------------------<br />:: retrieving :: commons-lang#commons-lang-caller<br /> confs: [default, master, compile, provided, runtime, system, sources, javadoc, optional]<br /> 4 artifacts copied, 0 already retrieved (1180kB/30ms)<br /></pre><br />But if I have multiple artifacts, this could be pretty cumbersome. Since this is Ruby, I can just put this in a method and call it repeatedly:<br /><pre>def ivy_retrieve(org, mod, rev)<br />  ant.retrieve :organisation =&gt; org,<br />    :module =&gt; mod,<br />    :revision =&gt; rev,<br />    :pattern =&gt; 'javalib/[conf]/[artifact].[ext]',<br />    :inline =&gt; true<br />end<br /><br />artifacts = %w[<br />  commons-lang commons-lang 2.1<br />  org.jruby jruby 1.4.0<br />]<br /><br />task :go =&gt; "ivy:install" do<br />  artifacts.each_slice(3) do |*artifact|<br />    ivy_retrieve(*artifact)<br />  end<br />end</pre><br />Look for JRuby 1.5 release candidates soon, and let us know what you think of the new Ant integration!