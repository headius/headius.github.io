---
layout: post
title: RubyInline for JRuby? Easy!
date: '2008-03-08T17:32:00.000-08:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:31.854-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-7354048346376490502
blogger_orig_url: http://blog.headius.com/2008/03/rubyinline-for-jruby-easy.html
---

With JRuby 1.1 approaching, performance looking great, and general Ruby compatibility better than its ever been, we've started to branch out into more libraries and applications. So a couple days ago, I thought I'd make good on a promise to myself and have a look at getting RubyInline working on JRuby.<br /><br /><a href="http://www.zenspider.com/ZSS/Products/RubyInline/">RubyInline</a> is a library by <a href="http://blog.zenspider.com/">Ryan "zenspider" Davis</a> which allows you to embed snippits of C code into your Ruby scripts. RubyInline does a minimal parse of that source, and based on the function signature you provide it wires it to the containing class as a Ruby method entry point and performs appropriate entry and exit type conversion to whatever C types you happen to use. It's particularly useful if you have a small algorithm you need to run fast, and you'd like to run it in a somewhat faster language by "throwing work over" to it.<br /><br />Here's the example of RubyInline from Ryan's page:<br /><pre>class MyTest<br /><br />  def factorial(n)<br />    f = 1<br />    n.downto(2) { |x| f *= x }<br />    f<br />  end<br /><br />  inline do |builder|<br />    builder.c "<br />    long factorial_c(int max) {<br />      int i=max, result=1;<br />      while (i >= 2) { result *= i--; }<br />      return result;<br />    }"<br />  end<br />end</pre><br />The interesting bit is the builder.c call, one of several functions on the C builder. Others allow you to add arbitrary preamble code, imports, and "bare" methods (with no type conversion) among other things. And as you'd expect, performance is greatly improved by writing some algorithms in C instead of Ruby.<br /><br />Naturally, we want to have the same thing work in Java, and ideally use the same API and the same RubyInline plumbing for the rest of it. So then, I present to you <a href="http://jruby-extras.rubyforge.org/svn/trunk/java_inline/lib/java_inline.rb">java_inline, a RubyInline builder for JRuby</a>!<br /><br />This represents about four hours of work, and although it doesn't yet have a complete complement of tests and could use some "robustification", it's already working in about 100 lines of code. It's made far easier in JRuby than in C Ruby because we already have a full-features Java integration layer to handle the argument mapping.<br /><br />Here's a <a href="http://jruby-extras.rubyforge.org/svn/trunk/java_inline/samples/fastmath.rb">sample java_inline script</a> to show what it looks like, similar to the fastmath.rb sample provided with RubyInline.<br /><br />So how does it work? Well the Ruby side of things is largely the same as RubyInline's C builder...parse signature, compose the code together and compile it, and bind the method. It wires directly into the RubyInline pipeline, so all you need to do is install RubyInline, require the java_inline.rb script and you're all set. On the Java side, it's using the <a href="http://java.sun.com/javase/6/docs/api/javax/tools/package-summary.html">Java Compiler API</a>, provided in Java 6 implementations. (OT: This has to be the worst-designed API I've ever seen. Go see for yourself. It's cruel and unusual. I won't dwell on it.) So yes, this will only work on Java 6. Deal with it...or submit a patch to get it working on Java 5 as well :)<br /><br />It's not released in any official form yet, but I'll probably try to wire up a gem or something. I have to make sure I'm dotting my eyes and crossing my tees when I release stuff, even if it's only 100loc. But the repository is obviously public, so play with it, submit patches and improvements, and let me know if you'd like to use it or help work on it more. I'm also interest in suggestions for other libraries you'd like to see special JRuby support for, so pass that along too.