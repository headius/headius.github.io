---
layout: post
title: Java Native Access + JRuby = True POSIX
date: '2007-09-02T09:45:00.000-07:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:32.575-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-7019583724078793849
blogger_orig_url: http://blog.headius.com/2007/09/java-native-access-jruby-true-posix.html
---

I know, I know. It's got native code in it, and that's bad. It's using  JNI, and that's bad. But damn, for the life of me I couldn't see enough negatives to using Java Native Access that would outweigh the incredible positives. For example, the new POSIX interface I just committed:<br /><br /><pre>import com.sun.jna.Library;<br />public interface POSIX extends Library {<br />  public int chmod(String filename, int mode);<br />  public int chown(String filename, int owner, int group);<br />}</pre><br />Given this library, it takes a whopping <b class="moz-txt-star"><span class="moz-txt-tag">*</span>one line of code<span class="moz-txt-tag">*</span></b> to wire up the standard C library on a given platform:<br /><br /><pre>import com.sun.jna.Native<br />POSIX posix = (POSIX)Native.loadLibrary("c", POSIX.class);</pre><br />That's. It.<br /><br />So the idea behind JNA (<a href="http://jna.dev.java.net">jna.dev.java.net</a>) is to use a foreign function interface library (libffi in this case) to wire up C libraries  programmatically. This allows loading a library, inspecting its contents, and providing interfaces for those functions at runtime. They get bound to the appropriate places in the Java interface implementation, and JNA does some magic under the covers to handle converting types around. And so far, it appears to do an outstanding job.<br /><br />With this code in JRuby, we now have fully complete chmod and chown functionality. Before, we had to either shell out for chmod or use Java 6 APIs that wouldn't allow setting group bits, and we always had to shell out for chown because there's no Java API for it. Now, both work  <b class="moz-txt-star"><span class="moz-txt-tag">*</span>flawlessly<span class="moz-txt-tag">*</span></b>.<br /><br />The potential of this is enormous. Any C function we haven't been able to emulate, we can just use directly. Symlinks, fcntl, file stats and  tests, process spawning and control, on and on and on. And how's this for a wild idea: with a bit of trickery, we could actually wire up Ruby C extensions, just by providing JNI/JRuby-aware implementations of the Ruby C API functions.<br /><br />So there it is. I went ahead and committed a trunk build of JNA, and I'm working with the JNA guys to get a release out. We'll have to figure out the platform-specific bits, probably by just shipping a bunch of pre-built libraries (not a big deal; the JNI portion is about 26k), but the result will be true POSIX functionality in JRuby...the "last mile" of compatibility will largely be solved.<br /><br />Many thanks to Timothy Wall, who's been nursemaiding me through getting JNA working well, and who appears to be the primary driver of the JNA project right now. If you're interest in this stuff, check out JNA, start using it, make it popular. As far as I'm concerned this is how native access is supposed to be.<br /><br /><span style="font-weight:bold;"><span style="font-style:italic;">Update:</span></span> My mistake, Wayne Meissner has also been pouring a metric buttload of effort into JNA. Credit where credit's due!