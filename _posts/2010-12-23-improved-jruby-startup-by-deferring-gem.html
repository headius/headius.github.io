---
layout: post
title: Improved JRuby Startup by Deferring Gem Plugins
date: '2010-12-23T14:01:00.000-08:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:30.233-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-8270769560000473811
blogger_orig_url: http://blog.headius.com/2010/12/improved-jruby-startup-by-deferring-gem.html
---

Another present for you JRubyists out there!<br /><br />JRuby has had notoriously bad startup times. Not as bad as, say, IronRuby (sorry guys!), but definitely a big fat hit every time you need to run some Ruby code from the command line. Some of this overhead was related to JRuby, and we've steadily worked to improve that over the years. Some of it is due to the JVM, most commonly due to running on the "server" Hotspot VM or another JVM that does not have an interpreter (both of which start up considerably slower than Hotspot/OpenJDK's "client" mode). I've blogged <a href="{{ site.baseurl }}{% post_url 2010-03-01-jruby-startup-time-tips %}">tips and tricks for JRuby startup</a> before, and these mostly apply to vanilla JRuby startup performance.<br /><br />However, a large part of the overhead was not specifically due to JRuby or the JVM, but to RubyGems. RubyGems in version 1.3 added support for "plugins", whereby gems could include a specially-named file to extend the functionality of RubyGems itself. Most of these plugins added command-line tools like "gem push" for pushing a new gem to gemcutter.org (now built-in for pushing to rubygems.org). Unfortunately, the feature was originally added by having RubyGems do a full scan of all installed gems on every startup. If you only had a few gems, this was a minor problem. If you had more than a few, it became a big fat O(N) problem, where each of those N could be arbitrarily complex in themselves.<br /><br />The good news is that it looks like my proposed change – <a href="http://rubyforge.org/pipermail/rubygems-developers/2010-December/005898.html">making plugin scanning happen *only* when using the "gem" command</a> – appears likely to be approved for RubyGems 1.4, due out reasonably soon.<br /><br />Here's the <a href="https://gist.github.com/751969">patch</a> and the impact to RubyGems startup times are below. The first two times are without the patch, with the first time against a "cold" filesystem. The final time is with the patch in place. In all cases, it's against my local JRuby working copy, which has around 500 gems installed.<br /><br /><pre>~/projects/jruby ➔ jruby -e "t = Time.now; require 'rubygems'; puts Time.now - t"<br />17.09<br /><br />~/projects/jruby ➔ jruby -e "t = Time.now; require 'rubygems'; puts Time.now - t"<br />6.959<br /><br />~/projects/jruby ➔ git stash pop<br /># On branch master<br /># Changed but not updated:<br />#   (use "git add &lt;file&gt;..." to update what will be committed)<br />#   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)<br />#<br /># modified:   lib/ruby/site_ruby/1.8/rubygems.rb<br /># modified:   lib/ruby/site_ruby/1.8/rubygems/gem_runner.rb<br />...<br /><br />~/projects/jruby ➔ jruby -e "t = Time.now; require 'rubygems'; puts Time.now - t"<br />0.481</pre><br /><br />It's truly a shocking difference, and it's easy to see why JRuby (plus RubyGems) has had such a bad startup-time reputation.<br /><br />I've already made this change locally to JRuby's copy of RubyGems, which should help any users working against JRuby master. The change will almost certainly ship in JRuby 1.6, with RCs showing up in the next couple weeks. So with this change and my <a href="{{ site.baseurl }}{% post_url 2010-03-01-jruby-startup-time-tips %}">JRuby startup tips</a>, we're on the road to a much more pleasant JRuby experience.<br /><br />Happy Hacking!