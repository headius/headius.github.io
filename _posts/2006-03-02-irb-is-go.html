---
layout: post
title: IRB is GO!
date: '2006-03-02T16:52:00.000-08:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:34.909-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-9138151482180501551
blogger_orig_url: http://blog.headius.com/2006/03/irb-is-go.html
---

I should post about things not working more often.<br /><br />Within a few hours after my previous post, where I showed the world how IRB now starts up successfully in JRuby but does not work, I was back at it trying to fix the next few bugs preventing it from working. The first issue was a NullPointerException deep in the interpreter, when executing an "until" block. Our parser, for right or for wrong, was producing an AST "UntilNode" with no body. While this could be correct or incorrect behavior--since the "until" in question actually did have an empty body--we still were not handling it correctly. The interpreter assumed that all "until"s would have bodies, and when a body turned up null...kaboom. A fix to check for null and not attempt to evaluate the body was an easy, if not entirely kosher, way to fix it. Done.<br /><br />However, nothing could prepare me for what followed.<br /><br /><span style="font-family:courier new;">C:\JRubyWork\jruby3&gt;jruby C:\ruby\bin\irb<br />irb(#&lt;IRB::WorkSpace:0x5a9c6e</span><span style="font-family:courier new;">&gt;</span><span style="font-family:courier new;">):001:0</span><span style="font-family:courier new;">&gt;</span><span style="font-family:courier new;"> x = 1<br />=&gt; 1<br /></span><br />I expected that the "until" bug would go away...that much was easy. however, I did not expect the variable assignment to work. "Ok," I thought, "that's better progress than I expected, but let's try something more complicated."<br /><br /><span style="font-family:courier new;">irb(#&lt;IRB::WorkSpace:0x5a9c6e</span><span style="font-family:courier new;">&gt;</span><span style="font-family:courier new;">):002:0&gt; puts x<br />NameError: undefined local variable or method 'x' for</span><span style="font-family:courier new;"> #</span><span style="font-family:courier new;">&lt;</span><span style="font-family:courier new;">IRB::WorkSpace:0x5a9c6e</span><span style="font-family:courier new;">&gt;</span><br /><span style="font-family:courier new;">        from (irb):1:in `method_missing'<br />...<br /></span><br />Ahh, there's the comforting disappointment I was used to. The 'x' variable had been declared and assigned, but for whatever reason, it was not visible in the current scope.<br /><br />Normally, I would have continued on to fix this scoping issue, which certainly would have involved a complicated dive into JRuby internals, hunting for mishandled scopes, bindings, frames, and wrapper objects. In this case, however, I decided to give IRB's "single IRB" mode a try, which simplifies the logical scoping of the IRB workspace. What follows is a series of annotated IRB sessions running--yes, running successfully--under JRuby.<br /><br />This first demo shows something basic: a multiline do/end array iteration.<br /><br /><span style="font-family:courier new;">C:\JRubyWork\jruby3&gt;jruby C:\ruby\bin\irb --single-irb<br />irb(#&lt;irb::workspace:0x175ace6&gt;):001:0&gt; [1, 2, 3].each do |i|<br />irb(#&lt;irb::workspace:0x175ace6&gt;):002:1* puts i<br />irb(#&lt;irb::workspace:0x175ace6&gt;):003:1&gt; end<br />1<br />2<br />3<br />=&gt; [1, 2, 3]<br /></span><br />This confirmed several things:<br /><ul><li>method calls were working just fine</li><li>array instantiation and integer literals were ok</li><li>multi-line constructs were being handled correctly</li></ul>It is this last one that surprised me a bit. I had not expected multi-line constructs to work so well and without any problems, but there it was. Playing around a bit more, I discovered some other surprises:<br /><ul><li>line editing was working successfully, and I could arrow-key left and right to correct mistakes</li><li>command history was also working, so that up and down arrow would retrieve the next and previous lines, respectively</li><li>tab completion does not work</li></ul>Excluding the tab completion issue (hitting tab just inserts a "tab" character into the current line), the perfectly working line editing and command history totally blew me away. I have NEVER seen a console-mode Java application do such things so seamlessly, much less one running an interactive shell. It appears that IRB's fallback "StdioInputHandler" is far less "dumb" than I expected. It was making Java do things I didn't know Java could do. Excited, I pressed on.<br /><br />This next demonstration tests the declaration and instantiation of a multiline class, another area I thought would never work correctly.<br /><br /><span style="font-family:courier new;">irb(#&lt;irb::workspace:0x175ace6&gt;):001:0&gt; class MyClass<br />irb(#&lt;irb::workspace:0x175ace6&gt;):002:1&gt; def hello<br />irb(#&lt;irb::workspace:0x175ace6&gt;):003:2&gt; "Hello from IRB!"<br />irb(#&lt;irb::workspace:0x175ace6&gt;):004:2&gt; end<br />irb(#&lt;irb::workspace:0x175ace6&gt;):005:1&gt; end<br />=&gt; nil<br />irb(#&lt;irb::workspace:0x175ace6&gt;):006:0&gt; x = MyClass.new<br />=&gt; #&lt;myclass:0x1621fe6&gt;<br />irb(#&lt;irb::workspace:0x175ace6&gt;):007:0&gt; puts x.hello<br />Hello from IRB!<br />=&gt; nil<br /></span><br />Once again, JRuby (and IRB) thoroughly surprised me. Defining a class over multiple lines worked perfectly, just as you'd expect from IRB running under C Ruby. At this point, IRB was running so well I began to have some doubts. Could it be that IRB had called out to an external C Ruby process for running the interactive portion of the shell? Such a thing would not be unheard of; Rake launches external Ruby processes to run test cases, though you might never notice such a thing. There was, however, a simple way to confirm that I was actually seeing JRuby at work and not C Ruby: call Java code.<br /><br />JRuby's greatest strength lies, unsurprisingly, in its ability to neatly tie Ruby and Java code together. For what other purpose would we want Ruby running in the JVM than to take advantage of the wealth of libraries the Java world has to offer? The integration is improving more and more with each release, and has become extremely powerful, usable, and above all very Ruby-like.<br /><br />This next demonstration shows IRB calling Java code.<br /><br /><span style="font-family:courier new;">irb(#&lt;irb::workspace:0x175ace6&gt;):001:0&gt; require 'java'<br />=&gt; true<br />irb(#&lt;irb::workspace:0x175ace6&gt;):002:0&gt; include_class "java.lang.System"<br />=&gt; ["java.lang.System"]<br />irb(#&lt;irb::workspace:0x175ace6&gt;):003:0&gt; System.out.println("Hello from Java")<br />Hello from Java<br />=&gt; nil<br /></span><br />Now some of you may not realize what this means. The ability to interactively script and exercise Java code from within an IRB session has huge potential for testing Java code, debugging JRuby (perhaps that's more exciting to me...oh well), and providing all the interactive goodies that Rubyists have taken for granted with the power and variety of Java's capabilities.<br /><br />So, a final demonstration is in order.<br /><br /><span style="font-family:courier new;">irb(#&lt;irb::workspace:0x175ace6&gt;):001:0&gt; require 'java'<br />=&gt; true<br />irb(#&lt;irb::workspace:0x175ace6&gt;):002:0&gt; include_class "javax.swing.JFrame"<br />=&gt; ["javax.swing.JFrame"]<br />irb(#&lt;irb::workspace:0x175ace6&gt;):003:0&gt; include_class "javax.swing.JButton"<br />=&gt; ["javax.swing.JButton"]<br />irb(#&lt;irb::workspace:0x175ace6&gt;):004:0&gt; frame = JFrame.new("my frame")<br />=&gt; javax.swing.JFrame[long desc omitted...]<br />irb(#&lt;irb::workspace:0x175ace6&gt;):005:0&gt; button = JButton.new("my button")<br />=&gt; javax.swing.JButton[</span><span style="font-family:courier new;">long desc omitted...</span><span style="font-family:courier new;">]<br />irb(#&lt;irb::workspace:0x175ace6&gt;):006:0&gt; frame.contentPane.add(button)<br />=&gt; javax.swing.JButton[</span><span style="font-family:courier new;">long desc omitted...</span><span style="font-family:courier new;">]<br />irb(#&lt;irb::workspace:0x175ace6&gt;):007:0&gt; frame.setSize(200, 100)<br />=&gt; nil<br />irb(#&lt;irb::workspace:0x175ace6&gt;):008:0&gt; frame.show<br />=&gt; nil<br /></span><br />The result:<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://photos1.blogger.com/blogger/6914/2116/1600/irb_swing_result.gif"><img style="margin: 0pt 10px 10px 0pt; cursor: pointer;" src="http://photos1.blogger.com/blogger/6914/2116/320/irb_swing_result.gif" alt="It works! It really works!" border="0" /></a><br /><br />So there you have it. With a few small caveats (like --single-irb), IRB is actually up and working in JRuby, far sooner than I expected. This is turning out to be a really good week.