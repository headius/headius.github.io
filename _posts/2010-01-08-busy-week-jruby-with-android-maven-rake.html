---
layout: post
title: 'Busy Week: JRuby with Android, Maven, Rake, C exts, and More!'
date: '2010-01-08T12:20:00.000-08:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:30.622-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-6277985328313660080
blogger_orig_url: http://blog.headius.com/2010/01/busy-week-jruby-with-android-maven-rake.html
---

(How long has it been since I last blogged? Answer: a long time. I'll try to blog more frequently now that the (TOTALLY INSANE) fall conference season is over. Remind me to never have three conferences in a month ever again.)<br /><br />Hello friends! It's been a busy week! I thought I'd show some of what's happening with JRuby, so you know we're still here plugging away.<br /><br /><span style="font-weight:bold;">Android Update</span><br /><br />Earlier this week I helped Jan Berkel get the Ruboto IRB application working on a more recent JRuby build. There were a few minor tweaks needed, and Jan was interested in helping out, so I made the tweaks and added him as a committer.<br /><br />The Ruboto IRB project repository is here: <a href="http://github.com/headius/ruboto-irb">http://github.com/headius/ruboto-irb</a><br /><br />Lately my interest in JRuby on Android has increased. I realized very recently that JRuby is just about the only mainstream JVM languge that can create *new* code while running on the device, which opens up a whole host of possibilities. It is not possible to implement an interactive shell in Groovy or Scala or Clojure, for example, since they all must first compile code to JVM bytecode, and JVM bytecode can't run on the Dalvik VM directly.<br /><br />As I played with Ruboto IRB this week, I discovered something even more exciting: almost all the bugs that prevented JRuby from working well in early Android releases have been solved! Specifically, the inability to reflect any android.* classes seems to be fixed in both Android 1.6 and Android 2.0.x. Why is this so cool? It's cool because with Ruboto IRB you can interactively play with almost any Android API:<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://img.skitch.com/20100108-1nr5rj4y7dpw4spfr9sf5w3ui3.jpg"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 342px; height: 501px;" src="http://img.skitch.com/20100108-1nr5rj4y7dpw4spfr9sf5w3ui3.jpg" border="0" alt="" /></a><br /><br />This example accesses the Activity (the IRB class in Ruboto IRB), constructs a new WebView, loads some HTML into it, and (not shown) replaces the content WebView. Interactively. On the device. Awesome.<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://img.skitch.com/20100108-dagfkf1thqktftghpnaigxhus5.jpg"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 343px; height: 501px;" src="http://img.skitch.com/20100108-dagfkf1thqktftghpnaigxhus5.jpg" border="0" alt="" /></a><br /><br />I am trusting you to not go mad with power, and to use Ruboto only for good.<br /><br /><span style="font-weight:bold;">RubyGems/Maven Integration</span><br /><br />JRuby has always been a Ruby implementation first, and as a result we've often neglected Java platform integration. But with Ruby 1.8.7 compatibility very solid and Ruby 1.9 work under way, we've started to turn our attentions toward Java again.<br /><br />One of the key areas for language integration is tool support. And for Java developers, tool support invariably involves Maven.<br /><br />About a year ago, I started a little project to turn Maven artifacts into RubyGems. The mapping was straightforward: both have dependencies, a name, a description, a unique identifier, version numbers, and a standard file format for describing a given package. The maven_gem project was my proof-of-concept that it's possible to merge the two worlds.<br /><br />The maven_gem repository is here: <a href="http://github.com/jruby/maven_gem">http://github.com/jruby/maven_gem</a><br /><br />The project sat mostly dormant until I circled back to it this fall. But once I got the guys from Sonatype involved (purveyors of the Nexus Maven server) things really got interesting.<br /><br />Thanks to Tamas Cservenak from Sonatype, we now have something once thought impossible: full RubyGems integration of all the Maven artifacts in the world!<br /><br />The Nexus RubyGems support repository is here: <a href="http://github.com/cstamas/nexus-ruby-support/">http://github.com/cstamas/nexus-ruby-support/</a><br /><br /><pre>~/projects/jruby âž” gem install com.lowagie.itext-rtf<br />Successfully installed bouncycastle.bcmail-jdk14-138-java<br />Successfully installed bouncycastle.bcprov-jdk14-138-java<br />Successfully installed bouncycastle.bctsp-jdk14-138-java<br />Successfully installed com.lowagie.itext-rtf-2.1.7-java<br />4 gems installed<br />Installing ri documentation for bouncycastle.bcmail-jdk14-138-java...<br />Installing ri documentation for bouncycastle.bcprov-jdk14-138-java...<br />Installing ri documentation for bouncycastle.bctsp-jdk14-138-java...<br />Installing ri documentation for com.lowagie.itext-rtf-2.1.7-java...<br />Installing RDoc documentation for bouncycastle.bcmail-jdk14-138-java...<br />Installing RDoc documentation for bouncycastle.bcprov-jdk14-138-java...<br />Installing RDoc documentation for bouncycastle.bctsp-jdk14-138-java...<br />Installing RDoc documentation for com.lowagie.itext-rtf-2.1.7-java...</pre><br /><br />Here's a an example of a full session, where I additionally install Rhino and then use it from IRB: <a href="http://gist.github.com/271764">http://gist.github.com/271764</a><br /><br />I should reiterate what this means for JRuby users: as of JRuby 1.5, you'll be able to install or use in dependencies any Java library ever published to the public Maven repository. In short, you now have an additional 60000-some libraries at your fingertips. Awesome, no?<br /><br />There are some remaining issues to work through, like the fact that RubyGems itself chokes on that many gems when generating indexes, but there's a test server up and working. We'll get all the issues resolved by the time we release JRuby 1.5 RC1. Jump on the JRuby mailing list if you're like to discuss this new capability.<br /><br /><span style="font-weight:bold;">Rake? Ant? Why not Both?</span><br /><br />Another item on the integration front is Tom Enebo's work on providing seamless two-way integration of Rake (Ruby's build tool) and Ant. There's three aspects to Rake/Ant integration:<br /><ul><li>Using Rake tasks from Ant and Ant tasks from Rake</li><li>Calling Rake targets from Ant and Ant targets from Rake</li><li>Mixed build systems with part in Rake and part in Ant</li></ul>Tom's work so far has focused on the first bullet, but the other two will come along as well. You'll be able to translate your Ant script to Rake and have it work without modification, call out to Rake from Ant, include a Rakefile in Ant and use its targets, and so on.<br /><br />Here's an example of pulling in a build.xml file, depending on its targets, and calling Ant tasks from Rake:<br /><pre>require 'ant'<br /><br />ant.load 'build.xml' # defines tasks :mkdir + :setup in ant!<br /><br />task :compile => [:mkdir, :setup] do<br />  ant.javac(:srcdir => src_dir, :destdir => "./build/classes") do<br />    classpath :refid => "project.class.path" <br />  end<br />end</pre><br />Ideally we'll cover all possible integration scenarios, and finally blur the lines between Rake and Ant. And we'll be able to move JRuby's build into Rake, which will make all of us very happy. Look forward to this in JRuby 1.5 as well.<br /><br /><span style="font-weight:bold;">The C Extension Question</span><br /><br />One aspect of Ruby itself that we've punted on is support for Ruby's C extension API. We haven't done that to spite C extension users or developers--far from it...we'd love to flip a switch and have C extensions magically work. The problem is that Ruby's C API provides too-invasive access to the internals of objects, and there's just no way we can support that sort of access without incurring a massive overhead (because we'd have to copy stuff back and forth for every operation).<br /><br />But there's another possibility we've started to explore: supporting only a "safe" subset of the Ruby C API, and providing a few additional functions to replace the "unsafe" invasive bits. To that end, we (as in Wayne Meissner, creator of the FFI implementations for JRuby and Ruby) have cleaned up and published a C extension API shim library to Github.<br /><br />The JRuby C extension shim library repository is here: <a href="http://github.com/wmeissner/jruby-cext">http://github.com/wmeissner/jruby-cext</a><br /><br />Last night I spent some time getting this building and working on OS X, and to my surprise I was able to get a (very) trivial C extension to work!<br /><br />Here's the part in C. Note that this is identical to what you'd write if you were implementing the extension for Ruby:<br /><pre>#include &lt;stdio.h&gt;<br />#include &lt;ruby.h&gt;<br /> <br />VALUE HelloModule = Qnil;<br />VALUE HelloClass = Qnil;<br /> <br />VALUE say_hello(VALUE self, VALUE hello);<br />VALUE get_hello(VALUE self);<br /> <br />void<br />Init_defineclass()<br />{<br />    HelloClass = rb_define_class("Hello", rb_cObject);<br />    rb_define_method(HelloClass, "get_hello", get_hello, 0);<br />    rb_define_method(HelloClass, "say_hello", say_hello, 1);<br />}<br /> <br />VALUE<br />say_hello(VALUE self, VALUE hello)<br />{<br />    return Qnil;<br />}<br />VALUE<br />get_hello(VALUE self)<br />{<br />    return rb_str_new2("Hello, World");<br />}</pre><br />Here's the little snippit of Ruby code that loads and calls it. Note that the ModuleLoader logic would be hidden behind require/load in a final version of the C extension support.<br /><pre>require 'java'<br /> <br />m = org.jruby.cext.ModuleLoader.new<br />m.load(self, "defineclass")<br /> <br />h = Hello.new<br />puts "Hello.new returned #{h.inspect}"<br />puts "h.get_hello returns #{h.get_hello}"</pre><br />Among the C API pieces we probably won't ever support are things like RSTRING, RARRAY, RHASH that give direct access to string, array, and hash internals, anything dealing with Ruby's threads or runtime, and so on. Basically the pieces that don't fit well into JNI (the Java VM C API) would not be supported.<br /><br />It's also worth mentioning that this is really a user-driven venture. If you are interested in a C extension API for JRuby, then you'll need to help us get there. Not only are we plenty busy with Java and Ruby support, we are also not extension authors ourselves. Have a look at the repository, hop on the JRuby dev list, and we'll start collaborating.<br /><br /><span style="font-weight:bold;">JRuby in 2010</span><br /><br />There's a lot more coming for JRuby in 2010. We're going to finally let you create "real" Java classes from Ruby code that you can compile against, serialize, annotate, and specify in configuration files. We're going to offer JRuby development support to help prioritize and accelerate bug fixes for commercial users that really need them. We're going to have a beautiful, simple deployment option in Engine Yard Cloud, with fire-and-forget for your JRuby-based applications (including any non-Ruby libraries and code you might use like Java, Scala or Clojure). And we're going to finally publish a JRuby book, with all the walkthroughs, reference material, and troubleshooting tips you'll need to adopt JRuby today.<br /><br />It's going to be a great year...and a lot of fun.