---
layout: post
title: Rails 1.1.4 Runs Unmodified in JRuby
date: '2006-07-01T14:52:00.000-07:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:34.553-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-5959940968882434421
blogger_orig_url: http://blog.headius.com/2006/07/rails-114-runs-unmodified-in-jruby.html
---

<a href="http://weblog.rubyonrails.org/2006/6/30/rails-1-1-4-security-fix-without-breakage">Rails 1.1.4 was released on Friday</a> to very little fanfare. It was basically a fixit release for routing logic that broke in the 1.1.3 release (which broke while fixing a security issue in 1.1.2, etc). However, there's a less visible but vastly more interesting fix (for JRubyists) also included in 1.1.4.<br />

<br /><span style="font-weight: bold;">Esoterica</span><br /><br />Rails pre-1.1.4 used a peculiar block syntax to handle simple array and hash assignment:<br /><br /><span style="font-family:courier new;">options = {} # a hash<br />...<br />some_object.some_method { |options[:key]| }<br /></span><br />Which basically boils down to this:<br /><br /><span style="font-family:courier new;">some_object.some_method { |v| options[:key] = v }</span><br /><br />The former is certainly terse, but it takes a little head-twisting to follow what's going on. Inifinitely more serious: it doesn't work in JRuby.<br /><br /><span style="font-weight: bold;">Anguish</span><br /><br />I don't know when this syntax became valid or if it's always been valid, but it is seldom used. We had not seen it anywhere except in Rails, and there it's only used in a few top-level scripts for gathering command-line options. The level of effort to implement this missing functionality in JRuby is nontrivial:<br /><ul><li>there are parser changes necessary to treat the block arg as an assignment to a hash/array, which is a Call instead of a DVar (dynamic var)</li><li>there are interpreter changes to allow Call nodes to appear in block arg lists</li></ul><span style="font-weight: bold;">Salvation</span><br /><br />Naturally, we wanted to avoid adding this functionality if possible, so I emailed the <a href="http://www.ruby-lang.org/en/20020104.html">ruby-core mailing list</a> to ask the man himself, matz, whether this was an accepted standard. <a href="http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-core/7612">His response</a> was music to my ears:<br /><blockquote>FYI, in the future, block parameters will be restricted to local variables only, so that I don't recommend using something other than local variables for the parameters.</blockquote><span style="font-weight: bold;">Redemption</span><br /><br />Being the rabble-rouser that I am, and armed with matz's Word, I contacted the Rails team about "fixing" this unusual block syntax. Naturally, we wanted it fixed because it was going away, and not just because we're lazy. A <a href="http://dev.rubyonrails.org/ticket/4440">bug was created</a>, patches were assembled, and finally, in 1.1.4, this syntax has been fixed.<br /><br /><span style="font-weight: bold;">Enlightenment</span><br /><br />So what does this mean for JRuby? Until 1.1.4 was release, we had planned to include our own patch for this syntax, to allow Rails to work correctly. You would have had to patch Rails after installing, or none of the standard Rails scripts would run. Now, with the release of 1.1.4, the following will all work out-of-the-box with JRuby 0.9.0 (currently in RC status):<br /><br /><span style="font-family:courier new;"><span style="font-family:courier new;">gem install rails --include-dependencies</span><br /><span style="font-family:courier new;"># and use --no-rdoc for now...it's too slow</span><br /><span style="font-family:courier new;">rails ~/myapp</span><br /><span style="font-family:courier new;"># might need to tweak the rails script a bit to fix the shebang, or just call "jruby path/to/rails"</span><br /><span style="font-family:courier new;">cd ~/myapp</span><br /><span style="font-family:courier new;">jruby script/generate controller MyTest hello</span><br /><span style="font-family:courier new;">jruby script/server webrick</span><br /><span style="font-family:courier new;"># specify webrick explicitly; Rails uses platform-dependent tricks otherwise</span><br /><br />And suddenly, you have http://localhost:3000/mytest/hello running JRuby on Rails.<br /><br />We'll have a much better HOWTO packed into the 090 release, and I'll certainly be blogging on various aspects of JRuby on Rails over the next week or two. Keep in mind that we don't officially "support" Rails just yet; there's more work to do. We are, however, another leap beyond the JavaOne demo, and at this rate things are looking very good for an end-of-Summer JRuby 1.0.<br /></span>