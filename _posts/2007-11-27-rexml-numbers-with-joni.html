---
layout: post
title: REXML Numbers With Joni
date: '2007-11-27T20:54:00.000-08:00'
author: headius
tags: 
modified_time: '2011-01-25T21:44:32.182-08:00'
blogger_id: tag:blogger.com,1999:blog-4704664917418794835.post-848903972683695010
blogger_orig_url: http://blog.headius.com/2007/11/rexml-numbers-with-joni.html
---

As Ola reported earlier today, <a href="http://ola-bini.blogspot.com/2007/11/joni-merged-to-jruby-trunk.html">we've merged Joni</a>, Marcin Mielczynski's port of <a href="http://www.geocities.jp/kosako3/oniguruma/">Oniguruma</a>, to JRuby trunk. Here's the description from the Oniguruma home page:<br /><blockquote>Oniguruma is a regular expressions library.<br />The characteristics of this library is that different character encoding<br />for every regular expression object can be specified.</blockquote>The benefit for us is avoiding the encode/decode we previously had to do for every regular expression match, since Ruby uses byte[]-based strings and all Java regular expression engines work with char[]. You can imagine the overhead all that array churn introduced.<br /><br />After running through a series of basic optimizations, most of the key expressions we worried about were performing as well as or much better than JRegex, so Ola went through with the conversion over the past couple days. Marcin is continuing to work on various optimizations, but both Ola and I have been playing with the new code. And it's looking great.<br /><br />You may remember I reported recently about how the <a href="http://headius.blogspot.com/2007/10/another-performance-discovery-rexml.html">regexp bottleneck impacted XML parsing with REXML</a>. Here's the numbers run against JRuby immediately before merging Joni:<br /><pre>read content from stream, no DOM<br />3.362000   0.000000   3.362000 (  3.362000)<br />1.232000   0.000000   1.232000 (  1.232000)<br />0.887000   0.000000   0.887000 (  0.887000)<br />1.009000   0.000000   1.009000 (  1.010000)<br />0.801000   0.000000   0.801000 (  0.801000)<br />read content once, no DOM<br />9.869000   0.000000   9.869000 (  9.869000)<br />9.779000   0.000000   9.779000 (  9.779000)<br />9.786000   0.000000   9.786000 (  9.786000)<br />9.655000   0.000000   9.655000 (  9.655000)<br />9.601000   0.000000   9.601000 (  9.601000)<br />read content from stream, build DOM<br />1.368000   0.000000   1.368000 (  1.368000)<br />1.297000   0.000000   1.297000 (  1.297000)<br />1.192000   0.000000   1.192000 (  1.192000)<br />1.131000   0.000000   1.131000 (  1.131000)<br />0.812000   0.000000   0.812000 (  0.812000)<br />read content once, build DOM<br />10.595000   0.000000  10.595000 ( 10.595000)<br />9.489000   0.000000   9.489000 (  9.488000)<br />9.947000   0.000000   9.947000 (  9.947000)<br />9.821000   0.000000   9.821000 (  9.821000)<br />9.414000   0.000000   9.414000 (  9.415000)</pre>And here's the performance numbers today, with Joni:<br /><pre>read content from stream, no DOM<br />2.309000   0.000000   2.309000 (  2.308000)<br />1.217000   0.000000   1.217000 (  1.217000)<br />0.776000   0.000000   0.776000 (  0.776000)<br />0.825000   0.000000   0.825000 (  0.825000)<br />0.637000   0.000000   0.637000 (  0.637000)<br />read content once, no DOM<br />0.370000   0.000000   0.370000 (  0.369000)<br />0.415000   0.000000   0.415000 (  0.415000)<br />0.288000   0.000000   0.288000 (  0.288000)<br />0.260000   0.000000   0.260000 (  0.260000)<br />0.254000   0.000000   0.254000 (  0.254000)<br />read content from stream, build DOM<br />1.455000   0.000000   1.455000 (  1.455000)<br />0.916000   0.000000   0.916000 (  0.916000)<br />0.887000   0.000000   0.887000 (  0.888000)<br />0.827000   0.000000   0.827000 (  0.827000)<br />0.607000   0.000000   0.607000 (  0.607000)<br />read content once, build DOM<br />0.630000   0.000000   0.630000 (  0.630000)<br />0.664000   0.000000   0.664000 (  0.664000)<br />0.680000   0.000000   0.680000 (  0.680000)<br />0.553000   0.000000   0.553000 (  0.553000)<br />0.650000   0.000000   0.650000 (  0.650000)</pre>Marcin's being modest about the work, but we're all absolutely amazed by it.<br /><br />So finally the last really gigantic performance bottleneck in JRuby is gone, and it appears that JRuby's slow regexp era has come to a close. Next targets: the remaining issues with IO and Java integration performance.